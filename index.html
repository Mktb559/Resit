<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jana Resit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Jana Resit</h1>
            <p class="text-gray-600 dark:text-gray-300">Buat dan muat turun resit pembayaran dengan mudah.</p>
        </div>

        <!-- Form Input -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto">
            <div class="space-y-4">
                <!-- Pilihan Bahasa -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pilihan Bahasa</label>
                    <select id="language" onchange="changeLanguage()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                        <option value="ms">Bahasa Melayu</option>
                        <option value="en">English</option>
                    </select>
                </div>

                <!-- Upload Logo -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Logo Syarikat</label>
                    <input type="file" id="logoUpload" accept="image/*" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Nama Pelanggan -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelCustomerName">Nama Pelanggan</label>
                    <input type="text" id="customerName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" placeholder="Masukkan Nama">
                </div>

                <!-- Nomor Bill -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelBillNumber">No. Bill</label>
                    <input type="text" id="billNumber" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" placeholder="Masukkan No. Bill">
                </div>

                <!-- Mata Wang -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelCurrency">Mata Wang</label>
                    <select id="currency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                        <option value="RM">RM (Ringgit Malaysia)</option>
                        <option value="USD">USD (Dolar Amerika)</option>
                        <option value="SGD">SGD (Dolar Singapura)</option>
                    </select>
                </div>

                <!-- Item dan Harga -->
                <div id="itemList" class="space-y-2">
                    <div class="flex space-x-2">
                        <input type="text" placeholder="Nama Item" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                        <input type="number" placeholder="Harga" class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
                <button onclick="addItem()" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-white" id="buttonAddItem">Tambah Item</button>

                <!-- Diskaun -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelDiscount">Diskaun (%)</label>
                    <input type="number" id="discount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" placeholder="Masukkan Diskaun">
                </div>

                <!-- GST/SST -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelTax">GST/SST (%)</label>
                    <input type="number" id="tax" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" placeholder="Masukkan GST/SST">
                </div>

                <!-- Status Pembayaran -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelPaymentStatus">Status Pembayaran</label>
                    <select id="paymentStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                        <option value="Pending">Pending</option>
                        <option value="Complete">Complete</option>
                    </select>
                </div>

                <!-- Tarikh -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelDate">Tarikh</label>
                    <input type="date" id="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Upload QR Code -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelQRCode">QR Code (Opsional)</label>
                    <input type="file" id="qrUpload" accept="image/*" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Tandatangan Digital -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" id="labelSignature">Tandatangan Digital</label>
                    <canvas id="signaturePad" class="w-full h-32 border border-gray-300 rounded-md shadow-sm"></canvas>
                    <button onclick="clearSignature()" class="mt-2 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-white" id="buttonClearSignature">Padam Tandatangan</button>
                </div>
            </div>

            <!-- Tombol Jana Resit dan Muat Turun PDF -->
            <button onclick="generateReceipt()" class="mt-6 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600" id="buttonGenerateReceipt">Jana Resit</button>
            <button onclick="downloadPDF()" class="mt-4 w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600" id="buttonDownloadPDF">Muat Turun PDF</button>
            <button onclick="sendEmail()" class="mt-4 w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600" id="buttonSendEmail">Hantar Email</button>
        </div>

        <!-- Resi yang Dihasilkan -->
        <div id="receipt" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto mt-8 hidden">
            <div class="text-center">
                <img id="receiptLogo" src="" alt="Logo" class="w-20 h-20 mx-auto mb-4">
                <h1 class="text-2xl font-bold">Resit Pembayaran</h1>
                <p class="text-sm text-gray-500 dark:text-gray-300">Terima kasih atas pembayaran anda!</p>
            </div>
            <div class="mt-6">
                <table class="w-full">
                    <tr>
                        <td class="py-2"><strong>No. Bill:</strong></td>
                        <td class="py-2" id="receiptBillNumber"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>Nama Pelanggan:</strong></td>
                        <td class="py-2" id="receiptCustomerName"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>Jumlah Bayaran:</strong></td>
                        <td class="py-2" id="receiptAmount"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>Diskaun:</strong></td>
                        <td class="py-2" id="receiptDiscount"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>GST/SST:</strong></td>
                        <td class="py-2" id="receiptTax"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>Status Pembayaran:</strong></td>
                        <td class="py-2" id="receiptPaymentStatus"></td>
                    </tr>
                    <tr>
                        <td class="py-2"><strong>Tarikh:</strong></td>
                        <td class="py-2" id="receiptDate"></td>
                    </tr>
                </table>
            </div>
            <div id="qrcode" class="mt-4 flex justify-center">
                <img id="customQR" src="" alt="QR Code" class="hidden">
            </div>
            <div id="signatureImage" class="mt-4 flex justify-center"></div>
        </div>
    </div>

    <!-- Tombol Toggle Theme -->
    <button onclick="toggleTheme()" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-full shadow-lg dark:bg-white dark:text-gray-800">
        ðŸŒ“
    </button>

    <script>
        // Fungsi untuk menambah item
        function addItem() {
            const itemList = document.getElementById('itemList');
            const newItem = `
                <div class="flex space-x-2">
                    <input type="text" placeholder="Nama Item" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                    <input type="number" placeholder="Harga" class="w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-white">
                </div>
            `;
            itemList.insertAdjacentHTML('beforeend', newItem);
        }

        // Fungsi untuk menghitung total
        function calculateTotal() {
            const items = document.querySelectorAll('#itemList input[type="number"]');
            let total = 0;
            items.forEach(item => {
                total += parseFloat(item.value) || 0;
            });

            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const tax = parseFloat(document.getElementById('tax').value) || 0;

            total = total - (total * (discount / 100));
            total = total + (total * (tax / 100));

            return total;
        }

        // Fungsi untuk menghasilkan resi
        function generateReceipt() {
            const customerName = document.getElementById('customerName').value;
            const billNumber = document.getElementById('billNumber').value;
            const currency = document.getElementById('currency').value;
            const date = document.getElementById('date').value;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const tax = parseFloat(document.getElementById('tax').value) || 0;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const total = calculateTotal();

            if (!customerName || !billNumber || !date || total <= 0) {
                alert("Sila isi semua maklumat dengan betul!");
                return;
            }

            // Tampilkan resi
            document.getElementById('receipt').classList.remove('hidden');
            document.getElementById('receiptCustomerName').textContent = customerName;
            document.getElementById('receiptBillNumber').textContent = billNumber;
            document.getElementById('receiptAmount').textContent = `${currency} ${total.toFixed(2)}`;
            document.getElementById('receiptDiscount').textContent = `${discount}%`;
            document.getElementById('receiptTax').textContent = `${tax}%`;
            document.getElementById('receiptPaymentStatus').textContent = paymentStatus;
            document.getElementById('receiptDate').textContent = date;

            // Tampilkan logo yang diupload
            const logoUpload = document.getElementById('logoUpload');
            if (logoUpload.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('receiptLogo').src = e.target.result;
                };
                reader.readAsDataURL(logoUpload.files[0]);
            }

            // Tampilkan QR code yang diupload
            const qrUpload = document.getElementById('qrUpload');
            if (qrUpload.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('customQR').src = e.target.result;
                    document.getElementById('customQR').classList.remove('hidden');
                };
                reader.readAsDataURL(qrUpload.files[0]);
            } else {
                // Hasilkan QR code otomatis jika tidak ada upload
                const qrData = `No. Bill: ${billNumber}, Nama: ${customerName}, Jumlah: ${currency} ${total.toFixed(2)}, Tarikh: ${date}`;
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById("qrcode"), qrData);
            }

            // Tampilkan tandatangan digital
            const signaturePad = new SignaturePad(document.getElementById('signaturePad'));
            if (!signaturePad.isEmpty()) {
                const signature = signaturePad.toDataURL();
                document.getElementById('signatureImage').innerHTML = `<img src="${signature}" alt="Tandatangan" class="w-32 h-16">`;
            }
        }

        // Fungsi untuk muat turun PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const receiptElement = document.getElementById('receipt');
            doc.html(receiptElement, {
                callback: function (doc) {
                    doc.save('Resit.pdf');
                },
                x: 10,
                y: 10,
                width: 180,
                windowWidth: receiptElement.clientWidth
            });
        }

        // Fungsi untuk menghantar email
        async function sendEmail() {
            const emailData = {
                to: "pelanggan@example.com",
                subject: "Resi Pembayaran Anda",
                text: `Terima kasih atas pembayaran anda. Jumlah: RM ${calculateTotal()}`,
            };

            const response = await fetch('/api/sendEmail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emailData),
            });

            if (response.ok) {
                alert("Email berjaya dihantar!");
            } else {
                alert("Gagal menghantar email.");
            }
        }

        // Fungsi untuk mengesahkan QR code
        function verifyQRCode(image) {
            const code = jsQR(image.data, image.width, image.height);
            if (code) {
                alert("QR Code Sah: " + code.data);
            } else {
                alert("QR Code Tidak Sah.");
            }
        }

        // Fungsi untuk toggle tema (light/dark mode)
        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        // Fungsi untuk mengubah bahasa
        const translations = {
            ms: {
                customerName: "Nama Pelanggan",
                billNumber: "No. Bill",
                amount: "Jumlah Bayaran",
                discount: "Diskaun",
                tax: "GST/SST",
                paymentStatus: "Status Pembayaran",
                date: "Tarikh",
                generateReceipt: "Jana Resit",
                downloadPDF: "Muat Turun PDF",
                sendEmail: "Hantar Email",
                addItem: "Tambah Item",
                clearSignature: "Padam Tandatangan",
            },
            en: {
                customerName: "Customer Name",
                billNumber: "Bill Number",
                amount: "Amount",
                discount: "Discount",
                tax: "GST/SST",
                paymentStatus: "Payment Status",
                date: "Date",
                generateReceipt: "Generate Receipt",
                downloadPDF: "Download PDF",
                sendEmail: "Send Email",
                addItem: "Add Item",
                clearSignature: "Clear Signature",
            }
        };

        function changeLanguage() {
            const lang = document.getElementById('language').value;
            document.getElementById('labelCustomerName').textContent = translations[lang].customerName;
            document.getElementById('labelBillNumber').textContent = translations[lang].billNumber;
            document.getElementById('labelCurrency').textContent = translations[lang].currency;
            document.getElementById('labelDiscount').textContent = translations[lang].discount;
            document.getElementById('labelTax').textContent = translations[lang].tax;
            document.getElementById('labelPaymentStatus').textContent = translations[lang].paymentStatus;
            document.getElementById('labelDate').textContent = translations[lang].date;
            document.getElementById('buttonGenerateReceipt').textContent = translations[lang].generateReceipt;
            document.getElementById('buttonDownloadPDF').textContent = translations[lang].downloadPDF;
            document.getElementById('buttonSendEmail').textContent = translations[lang].sendEmail;
            document.getElementById('buttonAddItem').textContent = translations[lang].addItem;
            document.getElementById('buttonClearSignature').textContent = translations[lang].clearSignature;
        }
    </script>
</body>
</html>
